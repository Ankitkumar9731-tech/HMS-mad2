{% extends "base.html" %}

{% block title %}Dr. {{ doctor.fullname }} Availability - HMS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-calendar-check"></i> Doctor's Availability</h2>
    <a href="{{ url_for('patient.doctor_view', doctor_id=doctor.id) }}" class="btn btn-secondary">Go Back</a>
</div>

<div class="card">
    <div class="card-body">
        <h5 class="mb-3">Dr. {{ doctor.fullname }} - {{ doctor.specialization }}</h5>
        <p class="text-muted">Select a time slot to book an appointment</p>
        
        <form method="POST" action="{{ url_for('patient.book_appointment') }}" id="booking-form">
            <input type="hidden" name="doctor_id" value="{{ doctor.id }}">
            <input type="hidden" name="appointment_date" id="selected-date">
            <input type="hidden" name="appointment_time" id="selected-time">
            
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Morning Slot (08:00 - 12:00)</th>
                            <th>Evening Slot (16:00 - 21:00)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for date in dates %}
                        {% set avail = availabilities.get(date) %}
                        <tr>
                            <td><strong>{{ date.strftime('%d/%m/%Y') }}</strong></td>
                            <td>
                                {% if avail and avail.morning_slot %}
                                    {% set booked = avail.morning_booked or 0 %}
                                    {% set available = avail.max_appointments_per_slot - booked %}
                                    {% if available > 0 %}
                                        <div class="availability-slot slot-available" 
                                             data-date="{{ date.strftime('%Y-%m-%d') }}" 
                                             data-time="08:00-12:00"
                                             onclick="selectSlot('{{ date.strftime('%Y-%m-%d') }}', '08:00-12:00', this)">
                                            08:00 - 12:00 ({{ available }} available)
                                        </div>
                                    {% else %}
                                        <div class="availability-slot slot-booked">
                                            08:00 - 12:00 (Fully Booked)
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="availability-slot" style="background-color: #6c757d; color: white;">
                                        Not Available
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                {% if avail and avail.evening_slot %}
                                    {% set booked = avail.evening_booked or 0 %}
                                    {% set available = avail.max_appointments_per_slot - booked %}
                                    {% if available > 0 %}
                                        <div class="availability-slot slot-available" 
                                             data-date="{{ date.strftime('%Y-%m-%d') }}" 
                                             data-time="16:00-21:00"
                                             onclick="selectSlot('{{ date.strftime('%Y-%m-%d') }}', '16:00-21:00', this)">
                                            16:00 - 21:00 ({{ available }} available)
                                        </div>
                                    {% else %}
                                        <div class="availability-slot slot-booked">
                                            16:00 - 21:00 (Fully Booked)
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="availability-slot" style="background-color: #6c757d; color: white;">
                                        Not Available
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="mt-3">
                <button type="submit" class="btn btn-primary" id="book-btn" disabled>Book Appointment</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedDate = null;
    let selectedTime = null;
    
    function selectSlot(date, time, element) {
        // Remove previous selection
        document.querySelectorAll('.slot-selected').forEach(el => {
            if (el.classList.contains('slot-available')) {
                el.classList.remove('slot-selected');
            }
        });
        
        // Add selection to clicked element
        element.classList.add('slot-selected');
        
        selectedDate = date;
        selectedTime = time;
        
        document.getElementById('selected-date').value = date;
        document.getElementById('selected-time').value = time;
        document.getElementById('book-btn').disabled = false;
    }
</script>
{% endblock %}

